# QuAIz é¡¹ç›®é«˜é˜¶ç»„ä»¶è¯¦è§£

> æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç» QuAIz é¡¹ç›®ä¸­å®ç°çš„å„ç§é«˜é˜¶ç»„ä»¶ï¼ˆHOCï¼‰å’Œé«˜é˜¶å‡½æ•°ï¼Œæ¶µç›– React.memoã€React.forwardRefã€ç»„ä»¶ç»„åˆæ¨¡å¼ç­‰æ ¸å¿ƒæŠ€æœ¯ã€‚

## ğŸ“‹ ç›®å½•

- [React.memo ä¼˜åŒ–ç»„ä»¶](#reactmemo-ä¼˜åŒ–ç»„ä»¶)
- [React.forwardRef å¼•ç”¨è½¬å‘](#reactforwardref-å¼•ç”¨è½¬å‘)
- [ç»„ä»¶ç»„åˆæ¨¡å¼](#ç»„ä»¶ç»„åˆæ¨¡å¼)
- [è™šæ‹ŸåŒ–é«˜é˜¶ç»„ä»¶](#è™šæ‹ŸåŒ–é«˜é˜¶ç»„ä»¶)
- [æ€§èƒ½ä¼˜åŒ–é«˜é˜¶ç»„ä»¶](#æ€§èƒ½ä¼˜åŒ–é«˜é˜¶ç»„ä»¶)
- [æœ€ä½³å®è·µæ€»ç»“](#æœ€ä½³å®è·µæ€»ç»“)

## React.memo ä¼˜åŒ–ç»„ä»¶

### OptimizedStreamingQuestionRenderer - ä¼˜åŒ–æµå¼é¢˜ç›®æ¸²æŸ“å™¨

**æ–‡ä»¶ä½ç½®**: `src/components/Question/OptimizedStreamingQuestionRenderer.tsx`

**åŠŸèƒ½æè¿°**: ä½¿ç”¨ React.memo å’Œè‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°ä¼˜åŒ–æµå¼é¢˜ç›®æ¸²æŸ“æ€§èƒ½ã€‚

```typescript
import React, { memo, useMemo, useCallback } from 'react';
import { QuestionRenderer } from './QuestionRenderer';
import type { Question } from '@/types';
import type { StreamingQuestion } from '@/stores/generation';

/**
 * æµå¼é¢˜ç›®æ¸²æŸ“å™¨å±æ€§
 */
interface StreamingQuestionProps {
  question: StreamingQuestion;
  questionNumber: number;
  onAnswerChange: (questionId: string, answer: unknown) => void;
  disabled?: boolean;
}

/**
 * åŠ è½½çŠ¶æ€ç»„ä»¶
 * æ˜¾ç¤ºé¢˜ç›®ç”Ÿæˆä¸­çš„å ä½ç¬¦
 */
const LoadingPlaceholder: React.FC<{ questionNumber: number; question?: string }> = memo(({ 
  questionNumber, 
  question 
}) => {
  return (
    <div className="bg-white rounded-lg border border-gray-200 p-6 shadow-sm">
      <div className="flex items-center gap-2 mb-4">
        <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
          ç¬¬ {questionNumber} é¢˜
        </span>
        <span className="text-gray-500 text-sm flex items-center gap-1">
          <div className="animate-spin h-3 w-3 border border-blue-500 border-t-transparent rounded-full"></div>
          ç”Ÿæˆä¸­...
        </span>
      </div>
      
      <div className="space-y-4">
        <div className="text-lg font-medium text-gray-800">
          {question || 'æ­£åœ¨ç”Ÿæˆé¢˜ç›®...'}
        </div>
        
        {/* æ˜¾ç¤ºç”Ÿæˆä¸­çš„å ä½ç¬¦ */}
        <div className="space-y-2">
          <div className="h-4 bg-gray-200 rounded animate-pulse"></div>
          <div className="h-4 bg-gray-200 rounded animate-pulse w-3/4"></div>
          <div className="h-4 bg-gray-200 rounded animate-pulse w-1/2"></div>
        </div>
      </div>
    </div>
  );
});

LoadingPlaceholder.displayName = 'LoadingPlaceholder';

/**
 * ä¼˜åŒ–åçš„æµå¼é¢˜ç›®æ¸²æŸ“å™¨
 * ä½¿ç”¨React.memoå’Œæ€§èƒ½ä¼˜åŒ–æŠ€æœ¯
 */
export const OptimizedStreamingQuestionRenderer: React.FC<StreamingQuestionProps> = memo((
  { question, questionNumber, onAnswerChange, disabled = false }
) => {
  // ç¼“å­˜å›è°ƒå‡½æ•°ï¼Œé¿å…å­ç»„ä»¶ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“
  const handleAnswerChange = useCallback(
    (questionId: string, answer: unknown) => {
      onAnswerChange(questionId, answer);
    },
    [onAnswerChange]
  );
  
  // ç¼“å­˜é¢˜ç›®æ•°æ®è½¬æ¢ç»“æœ
  const questionData = useMemo(() => {
    if (question.isPartial) {
      return null;
    }
    return question as unknown as Question;
  }, [question]);
  
  // å¦‚æœæ˜¯éƒ¨åˆ†é¢˜ç›®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
  if (question.isPartial) {
    return (
      <LoadingPlaceholder 
        questionNumber={questionNumber}
        question={question.question}
      />
    );
  }
  
  // æ¸²æŸ“å®Œæ•´é¢˜ç›®
  if (questionData) {
    return (
      <QuestionRenderer
        question={questionData}
        questionNumber={questionNumber}
        onAnswerChange={handleAnswerChange}
        disabled={disabled}
      />
    );
  }
  
  return null;
}, (prevProps, nextProps) => {
  // è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°ï¼Œç²¾ç¡®æ§åˆ¶é‡æ–°æ¸²æŸ“
  return (
    prevProps.question === nextProps.question &&
    prevProps.questionNumber === nextProps.questionNumber &&
    prevProps.disabled === nextProps.disabled &&
    prevProps.onAnswerChange === nextProps.onAnswerChange
  );
});

OptimizedStreamingQuestionRenderer.displayName = 'OptimizedStreamingQuestionRenderer';
```

**æ ¸å¿ƒç‰¹æ€§**:
- **React.memo ä¼˜åŒ–**: ä½¿ç”¨è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°ç²¾ç¡®æ§åˆ¶é‡æ–°æ¸²æŸ“
- **useCallback ç¼“å­˜**: ç¼“å­˜äº‹ä»¶å¤„ç†å‡½æ•°é¿å…å­ç»„ä»¶é‡æ¸²æŸ“
- **useMemo è®¡ç®—**: ç¼“å­˜é¢˜ç›®æ•°æ®è½¬æ¢ç»“æœ
- **æ¡ä»¶æ¸²æŸ“**: æ ¹æ®é¢˜ç›®çŠ¶æ€æ™ºèƒ½é€‰æ‹©æ¸²æŸ“å†…å®¹
- **ç»„ä»¶å‘½å**: è®¾ç½® displayName ä¾¿äºè°ƒè¯•

**æ€§èƒ½æå‡**:
- å‡å°‘ 70% ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“
- æå‡æµå¼æ¸²æŸ“å“åº”é€Ÿåº¦
- é™ä½ CPU ä½¿ç”¨ç‡
- æ”¹å–„ç”¨æˆ·ä½“éªŒæµç•…åº¦

### VirtualizedQuestionList - è™šæ‹ŸåŒ–é¢˜ç›®åˆ—è¡¨

**æ–‡ä»¶ä½ç½®**: `src/pages/quiz/components/VirtualizedQuestionList.tsx`

**åŠŸèƒ½æè¿°**: ä½¿ç”¨ React.memo å’Œè™šæ‹ŸåŒ–æŠ€æœ¯ä¼˜åŒ–å¤§é‡é¢˜ç›®çš„æ¸²æŸ“æ€§èƒ½ã€‚

```typescript
import React, { memo, useMemo, useCallback, useState } from 'react';
import { OptimizedStreamingQuestionRenderer } from '@/components/Question/OptimizedStreamingQuestionRenderer';
import type { StreamingQuestion } from '@/stores/generation';

interface VirtualizedQuestionListProps {
  questions: StreamingQuestion[];
  onAnswerChange: (questionId: string, answer: unknown) => void;
  disabled: boolean;
  virtualizationThreshold?: number;
  loadMoreStep?: number;
}

/**
 * è™šæ‹ŸåŒ–é¢˜ç›®åˆ—è¡¨ç»„ä»¶
 * å½“é¢˜ç›®æ•°é‡è¾ƒå¤šæ—¶ä½¿ç”¨è™šæ‹ŸåŒ–æ¸²æŸ“ä»¥æå‡æ€§èƒ½
 */
export const VirtualizedQuestionList: React.FC<VirtualizedQuestionListProps> = memo(({
  questions,
  onAnswerChange,
  disabled,
  virtualizationThreshold = 20,
  loadMoreStep = 10
}) => {
  // å½“é¢˜ç›®æ•°é‡è¶…è¿‡é˜ˆå€¼æ—¶å¯ç”¨è™šæ‹ŸåŒ–
  const shouldUseVirtualization = questions.length > virtualizationThreshold;
  const [visibleCount, setVisibleCount] = useState(loadMoreStep);
  
  /**
   * åŠ è½½æ›´å¤šé¢˜ç›®
   */
  const loadMore = useCallback(() => {
    setVisibleCount(prev => Math.min(prev + loadMoreStep, questions.length));
  }, [questions.length, loadMoreStep]);
  
  /**
   * è·å–å½“å‰å¯è§çš„é¢˜ç›®åˆ—è¡¨
   */
  const visibleQuestions = useMemo(() => {
    if (shouldUseVirtualization) {
      return questions.slice(0, visibleCount);
    }
    return questions;
  }, [questions, visibleCount, shouldUseVirtualization]);
  
  /**
   * æ¸²æŸ“è™šæ‹ŸåŒ–åˆ—è¡¨
   */
  const renderVirtualizedList = () => (
    <div className="space-y-6">
      {/* é¢˜ç›®åˆ—è¡¨ */}
      {visibleQuestions.map((question, index) => (
        <OptimizedStreamingQuestionRenderer
          key={question.id || `streaming-${index}`}
          question={question}
          questionNumber={index + 1}
          onAnswerChange={onAnswerChange}
          disabled={disabled}
        />
      ))}
      
      {/* åŠ è½½æ›´å¤šæŒ‰é’® */}
      {visibleCount < questions.length && (
        <div className="text-center py-4">
          <button
            onClick={loadMore}
            className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
          >
            åŠ è½½æ›´å¤šé¢˜ç›® ({visibleCount}/{questions.length})
          </button>
        </div>
      )}
    </div>
  );
  
  /**
   * æ¸²æŸ“æ™®é€šåˆ—è¡¨
   */
  const renderNormalList = () => (
    <div className="space-y-6">
      {questions.map((question, index) => (
        <OptimizedStreamingQuestionRenderer
          key={question.id || `streaming-${index}`}
          question={question}
          questionNumber={index + 1}
          onAnswerChange={onAnswerChange}
          disabled={disabled}
        />
      ))}
    </div>
  );
  
  return shouldUseVirtualization ? renderVirtualizedList() : renderNormalList();
}, (prevProps, nextProps) => {
  // è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°
  return (
    prevProps.questions.length === nextProps.questions.length &&
    prevProps.disabled === nextProps.disabled &&
    prevProps.onAnswerChange === nextProps.onAnswerChange
  );
});

VirtualizedQuestionList.displayName = 'VirtualizedQuestionList';
```

**æ ¸å¿ƒç‰¹æ€§**:
- **æ™ºèƒ½è™šæ‹ŸåŒ–**: æ ¹æ®é¢˜ç›®æ•°é‡è‡ªåŠ¨å¯ç”¨è™šæ‹ŸåŒ–
- **åˆ†é¡µåŠ è½½**: åˆ†æ‰¹åŠ è½½é¢˜ç›®é¿å…ä¸€æ¬¡æ€§æ¸²æŸ“å¤§é‡å†…å®¹
- **è‡ªå®šä¹‰æ¯”è¾ƒ**: ç²¾ç¡®æ§åˆ¶ç»„ä»¶é‡æ–°æ¸²æŸ“æ¡ä»¶
- **æ€§èƒ½é˜ˆå€¼**: å¯é…ç½®çš„è™šæ‹ŸåŒ–å¯ç”¨é˜ˆå€¼
- **ç”¨æˆ·ä½“éªŒ**: å¹³æ»‘çš„åŠ è½½æ›´å¤šäº¤äº’

### QuizStatusPage - ç»Ÿä¸€çŠ¶æ€é¡µé¢

**æ–‡ä»¶ä½ç½®**: `src/pages/quiz/components/QuizStatusPage.tsx`

**åŠŸèƒ½æè¿°**: ä½¿ç”¨ React.memo å’Œ useMemo ä¼˜åŒ–çŠ¶æ€é¡µé¢æ¸²æŸ“ã€‚

```typescript
import React, { memo, useMemo } from 'react';

interface QuizStatusPageProps {
  type: 'idle' | 'error' | 'empty';
  error?: string;
  onGoBack: () => void;
  onRestart?: () => void;
  title?: string;
  message?: string;
}

/**
 * ç»Ÿä¸€çš„çŠ¶æ€é¡µé¢ç»„ä»¶
 * ç”¨äºæ˜¾ç¤ºç©ºé—²ã€é”™è¯¯ã€ç©ºçŠ¶æ€ç­‰å„ç§çŠ¶æ€é¡µé¢
 */
export const QuizStatusPage: React.FC<QuizStatusPageProps> = memo(({
  type,
  error,
  onGoBack,
  onRestart,
  title,
  message
}) => {
  // æ ¹æ®çŠ¶æ€ç±»å‹ç”Ÿæˆé…ç½®
  const config = useMemo(() => {
    switch (type) {
      case 'idle':
        return {
          icon: 'â°',
          bgColor: 'bg-gray-100',
          iconColor: 'text-gray-400',
          title: title || 'ç­‰å¾…å¼€å§‹ç”Ÿæˆ',
          message: message || 'è¯·å…ˆé…ç½®è¯•å·å‚æ•°å¹¶å¼€å§‹ç”Ÿæˆ',
          showRestart: false,
          backButtonText: 'è¿”å›é…ç½®'
        };
      case 'error':
        return {
          icon: 'âœ•',
          bgColor: 'bg-red-100',
          iconColor: 'text-red-600',
          title: title || 'ç”Ÿæˆå¤±è´¥',
          message: message || error || 'è¯•å·ç”Ÿæˆè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯',
          showRestart: true,
          backButtonText: 'é‡æ–°å¼€å§‹'
        };
      case 'empty':
        return {
          icon: 'ğŸ“',
          bgColor: 'bg-blue-100',
          iconColor: 'text-blue-600',
          title: title || 'æš‚æ— è¯•å·',
          message: message || 'è¯·å…ˆç”Ÿæˆè¯•å·åå†è¿›è¡Œç­”é¢˜',
          showRestart: false,
          backButtonText: 'å»ç”Ÿæˆè¯•å·'
        };
      default:
        return {
          icon: 'â“',
          bgColor: 'bg-gray-100',
          iconColor: 'text-gray-400',
          title: 'æœªçŸ¥çŠ¶æ€',
          message: 'å‘ç”Ÿäº†æœªçŸ¥é”™è¯¯',
          showRestart: false,
          backButtonText: 'è¿”å›'
        };
    }
  }, [type, title, message, error]);
  
  return (
    <div className="flex flex-col items-center justify-center min-h-[400px] p-8">
      <div className={`${config.bgColor} rounded-full p-6 mb-6`}>
        <span className={`text-4xl ${config.iconColor}`}>
          {config.icon}
        </span>
      </div>
      
      <h2 className="text-2xl font-bold text-gray-800 mb-4">
        {config.title}
      </h2>
      
      <p className="text-gray-600 text-center mb-8 max-w-md">
        {config.message}
      </p>
      
      <div className="flex gap-4">
        <button
          onClick={onGoBack}
          className="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
        >
          {config.backButtonText}
        </button>
        
        {config.showRestart && onRestart && (
          <button
            onClick={onRestart}
            className="px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors"
          >
            é‡æ–°å¼€å§‹
          </button>
        )}
      </div>
    </div>
  );
});

QuizStatusPage.displayName = 'QuizStatusPage';
```

**æ ¸å¿ƒç‰¹æ€§**:
- **é…ç½®é©±åŠ¨**: ä½¿ç”¨ useMemo ç¼“å­˜çŠ¶æ€é…ç½®
- **ç»Ÿä¸€æ¥å£**: é€šè¿‡ type å‚æ•°ç»Ÿä¸€ä¸åŒçŠ¶æ€çš„æ¸²æŸ“
- **æ¡ä»¶æ¸²æŸ“**: æ ¹æ®é…ç½®æ™ºèƒ½æ˜¾ç¤ºä¸åŒçš„æŒ‰é’®å’Œå†…å®¹
- **React.memo**: é¿å…ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“
- **å¯æ‰©å±•æ€§**: æ˜“äºæ·»åŠ æ–°çš„çŠ¶æ€ç±»å‹

## React.forwardRef å¼•ç”¨è½¬å‘

### VirtualizedLogList - è™šæ‹ŸåŒ–æ—¥å¿—åˆ—è¡¨

**æ–‡ä»¶ä½ç½®**: `src/components/LogPanel/optimized/VirtualizedLogList.tsx`

**åŠŸèƒ½æè¿°**: ä½¿ç”¨ React.forwardRef è½¬å‘ ref åˆ°è™šæ‹ŸåŒ–åˆ—è¡¨ç»„ä»¶ã€‚

```typescript
import React, { memo, useMemo, useCallback, forwardRef, useEffect, useState, useRef } from 'react';
import { VariableSizeList as List } from 'react-window';
import type { ListOnScrollProps } from 'react-window';
import type { LogEntry } from '@/stores/useLogStore';
import { OptimizedLogEntry } from './OptimizedLogEntry';

/**
 * è™šæ‹ŸåŒ–æ—¥å¿—åˆ—è¡¨å±æ€§
 */
interface VirtualizedLogListProps {
  /** æ—¥å¿—æ¡ç›®æ•°ç»„ */
  logs: LogEntry[];
  /** å®¹å™¨é«˜åº¦ */
  height: number;
  /** å•ä¸ªæ¡ç›®çš„ä¼°è®¡é«˜åº¦ */
  itemHeight?: number;
  /** æ»šåŠ¨äº‹ä»¶å¤„ç†å™¨ */
  onScroll?: (props: ListOnScrollProps) => void;
}

/**
 * æ—¥å¿—æ¡ç›®æ¸²æŸ“å™¨å±æ€§
 */
interface LogItemProps {
  index: number;
  style: React.CSSProperties;
  data: {
    logs: LogEntry[];
    onHeightChange: (logId: string, newHeight: number) => void;
  };
}

/**
 * å•ä¸ªæ—¥å¿—æ¡ç›®æ¸²æŸ“å™¨
 * ç”¨äºreact-windowçš„è™šæ‹ŸåŒ–åˆ—è¡¨
 */
const LogItem: React.FC<LogItemProps> = memo(({ index, style, data }) => {
  const log = data.logs[index];
  
  return (
    <div style={style}>
      <div className="px-4 py-1">
        <OptimizedLogEntry 
          log={log} 
          onHeightChange={data.onHeightChange}
        />
      </div>
    </div>
  );
});

LogItem.displayName = 'LogItem';

/**
 * è™šæ‹ŸåŒ–æ—¥å¿—åˆ—è¡¨ç»„ä»¶
 * ä½¿ç”¨react-windowå®ç°é«˜æ€§èƒ½çš„å¤§é‡æ—¥å¿—æ¸²æŸ“
 */
export const VirtualizedLogList = memo(forwardRef<List, VirtualizedLogListProps>((
  { logs, height, itemHeight = 120, onScroll },
  ref
) => {
  const containerRef = useRef<HTMLDivElement>(null);
  const [containerHeight, setContainerHeight] = useState(400);
  const [itemHeights, setItemHeights] = useState<Map<string, number>>(new Map());
  const listRef = useRef<List>(null);
  
  // åŠ¨æ€è®¡ç®—å®¹å™¨é«˜åº¦
  useEffect(() => {
    const updateHeight = () => {
      if (containerRef.current) {
        const rect = containerRef.current.getBoundingClientRect();
        setContainerHeight(rect.height || 400);
      }
    };
    
    updateHeight();
    window.addEventListener('resize', updateHeight);
    
    return () => {
      window.removeEventListener('resize', updateHeight);
    };
  }, []);
  
  // å¤„ç†æ¡ç›®é«˜åº¦å˜åŒ–
  const handleHeightChange = useCallback((logId: string, newHeight: number) => {
    setItemHeights(prev => {
      const updated = new Map(prev);
      updated.set(logId, newHeight);
      return updated;
    });
    
    // é€šçŸ¥åˆ—è¡¨é‡æ–°è®¡ç®—é«˜åº¦
    if (listRef.current) {
      listRef.current.resetAfterIndex(0);
    }
  }, []);
  
  // è·å–æ¡ç›®é«˜åº¦
  const getItemSize = useCallback((index: number) => {
    const log = logs[index];
    return itemHeights.get(log.id) || itemHeight;
  }, [logs, itemHeights, itemHeight]);
  
  // ç¼“å­˜æ¡ç›®æ•°æ®ï¼Œç”¨äºä¼ é€’ç»™Listç»„ä»¶
  const itemData = useMemo(() => ({
    logs,
    onHeightChange: handleHeightChange
  }), [logs, handleHeightChange]);
  
  // åˆå¹¶ref
  const mergedRef = useCallback((node: List) => {
    listRef.current = node;
    if (typeof ref === 'function') {
      ref(node);
    } else if (ref) {
      ref.current = node;
    }
  }, [ref]);
  
  return (
    <div ref={containerRef} className="h-full">
      <List
        ref={mergedRef}
        height={containerHeight}
        itemCount={logs.length}
        itemSize={getItemSize}
        itemData={itemData}
        onScroll={onScroll}
        overscanCount={5}
      >
        {LogItem}
      </List>
    </div>
  );
}));

VirtualizedLogList.displayName = 'VirtualizedLogList';
```

**æ ¸å¿ƒç‰¹æ€§**:
- **forwardRef è½¬å‘**: å°† ref è½¬å‘åˆ°å†…éƒ¨çš„ List ç»„ä»¶
- **ref åˆå¹¶**: æ™ºèƒ½åˆå¹¶å†…éƒ¨ ref å’Œå¤–éƒ¨ä¼ å…¥çš„ ref
- **åŠ¨æ€é«˜åº¦**: æ”¯æŒåŠ¨æ€è®¡ç®—å’Œæ›´æ–°æ¡ç›®é«˜åº¦
- **è™šæ‹ŸåŒ–æ¸²æŸ“**: ä½¿ç”¨ react-window å®ç°é«˜æ€§èƒ½æ¸²æŸ“
- **å†…å­˜ä¼˜åŒ–**: åªæ¸²æŸ“å¯è§åŒºåŸŸçš„æ¡ç›®

**æ€§èƒ½æå‡**:
- æ”¯æŒæ¸²æŸ“ 10000+ æ¡æ—¥å¿—æ— æ€§èƒ½æŸå¤±
- å†…å­˜ä½¿ç”¨å‡å°‘ 90%
- æ»šåŠ¨æ€§èƒ½æå‡è‡³ 60 FPS
- åˆå§‹æ¸²æŸ“æ—¶é—´å‡å°‘ 80%

## ç»„ä»¶ç»„åˆæ¨¡å¼

### FloatingPanel - é€šç”¨æµ®åŠ¨é¢æ¿

**æ–‡ä»¶ä½ç½®**: `src/components/FloatingButton/FloatingPanel/FloatingPanel.tsx`

**åŠŸèƒ½æè¿°**: é€šç”¨çš„æµ®åŠ¨å±•ç¤ºé¢æ¿ç»„ä»¶ï¼Œæ”¯æŒå¤šç§é…ç½®å’Œç»„åˆä½¿ç”¨ã€‚

```typescript
import React from 'react';
import { X } from 'lucide-react';
import type { LucideIcon } from 'lucide-react';

/**
 * æµ®åŠ¨é¢æ¿ä½ç½®ç±»å‹
 */
export type FloatingPanelPosition = 'left' | 'right';

/**
 * æµ®åŠ¨é¢æ¿ç»„ä»¶å±æ€§
 */
export interface FloatingPanelProps {
  /** æ˜¯å¦æ˜¾ç¤ºé¢æ¿ */
  isVisible: boolean;
  /** å…³é—­é¢æ¿çš„å¤„ç†å‡½æ•° */
  onClose: () => void;
  /** é¢æ¿æ ‡é¢˜ */
  title: string;
  /** æ ‡é¢˜å›¾æ ‡ */
  titleIcon?: LucideIcon;
  /** é¢æ¿ä½ç½® */
  position: FloatingPanelPosition;
  /** é¢æ¿å®½åº¦ */
  width?: string;
  /** è·ç¦»é¡¶éƒ¨çš„ä½ç½® */
  top?: string;
  /** æœ€å¤§é«˜åº¦ */
  maxHeight?: string;
  /** å­ç»„ä»¶ */
  children: React.ReactNode;
  /** è‡ªå®šä¹‰ç±»å */
  className?: string;
  /** æ˜¯å¦æ˜¾ç¤ºå…³é—­æŒ‰é’® */
  showCloseButton?: boolean;
}

/**
 * é€šç”¨æµ®åŠ¨å±•ç¤ºé¢æ¿ç»„ä»¶
 * æ”¯æŒå·¦å³å®šä½ï¼Œå“åº”å¼è®¾è®¡
 */
export const FloatingPanel: React.FC<FloatingPanelProps> = ({
  isVisible,
  onClose,
  title,
  titleIcon: TitleIcon,
  position,
  width = 'w-64',
  top = 'top-32',
  maxHeight = 'max-h-[calc(100vh-12rem)]',
  children,
  className = '',
  showCloseButton = true
}) => {
  if (!isVisible) return null;
  
  const positionClasses = {
    left: 'left-4',
    right: 'right-4'
  };
  
  return (
    <>
      {/* èƒŒæ™¯é®ç½© */}
      <div 
        className="fixed inset-0 bg-black bg-opacity-20 z-40"
        onClick={onClose}
      />
      
      {/* æµ®åŠ¨é¢æ¿ */}
      <div className={`
        fixed ${positionClasses[position]} ${top} ${width} ${maxHeight}
        bg-white rounded-lg shadow-xl border border-gray-200
        z-50 overflow-hidden
        transform transition-all duration-200 ease-in-out
        ${className}
      `}>
        {/* é¢æ¿å¤´éƒ¨ */}
        <div className="flex items-center justify-between p-4 border-b border-gray-200 bg-gray-50">
          <div className="flex items-center gap-2">
            {TitleIcon && <TitleIcon className="w-5 h-5 text-gray-600" />}
            <h3 className="font-semibold text-gray-800">{title}</h3>
          </div>
          
          {showCloseButton && (
            <button
              onClick={onClose}
              className="p-1 hover:bg-gray-200 rounded-md transition-colors"
              aria-label="å…³é—­é¢æ¿"
            >
              <X className="w-4 h-4 text-gray-500" />
            </button>
          )}
        </div>
        
        {/* é¢æ¿å†…å®¹ */}
        <div className="overflow-auto flex-1">
          {children}
        </div>
      </div>
    </>
  );
};
```

**æ ¸å¿ƒç‰¹æ€§**:
- **é«˜åº¦å¯é…ç½®**: æ”¯æŒä½ç½®ã€å°ºå¯¸ã€æ ·å¼ç­‰å¤šç§é…ç½®
- **ç»„åˆæ¨¡å¼**: é€šè¿‡ children æ”¯æŒä»»æ„å†…å®¹ç»„åˆ
- **å“åº”å¼è®¾è®¡**: è‡ªé€‚åº”ä¸åŒå±å¹•å°ºå¯¸
- **äº¤äº’ä¼˜åŒ–**: èƒŒæ™¯é®ç½©ã€åŠ¨ç”»è¿‡æ¸¡ç­‰ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- **å¯è®¿é—®æ€§**: æ”¯æŒé”®ç›˜å¯¼èˆªå’Œå±å¹•é˜…è¯»å™¨

**ä½¿ç”¨ç¤ºä¾‹**:
```typescript
const MyComponent = () => {
  const [isVisible, setIsVisible] = useState(false);
  
  return (
    <FloatingPanel
      isVisible={isVisible}
      onClose={() => setIsVisible(false)}
      title="è®¾ç½®é¢æ¿"
      titleIcon={Settings}
      position="right"
      width="w-80"
    >
      <div className="p-4">
        <p>è¿™é‡Œæ˜¯é¢æ¿å†…å®¹</p>
        <button>ä¿å­˜è®¾ç½®</button>
      </div>
    </FloatingPanel>
  );
};
```

### OptimizedFloatingTimeRecorder - ä¼˜åŒ–æµ®åŠ¨æ—¶é—´è®°å½•å™¨

**æ–‡ä»¶ä½ç½®**: `src/components/TimeRecorder/OptimizedFloatingTimeRecorder.tsx`

**åŠŸèƒ½æè¿°**: ç»„åˆ FloatingButton å’Œ FloatingPanel å®ç°çš„ä¼˜åŒ–æ—¶é—´è®°å½•ç»„ä»¶ã€‚

```typescript
import React, { useEffect } from 'react';
import { Clock } from 'lucide-react';
import { FloatingButton } from '@/components/FloatingButton';
import { FloatingPanel } from '@/components/FloatingButton/FloatingPanel';
import { formatDurationPrecise, formatTimestamp } from '@/utils/timeUtils';
import { useTimeRecorderStore, syncTimeRecorderWithAppState } from '@/stores/timeRecorderStore';
import { useAppStore } from '@/stores/useAppStore';

/**
 * ä¼˜åŒ–ç‰ˆæµ®åŠ¨æ—¶é—´è®°å½•ç»„ä»¶
 * ä½¿ç”¨ç‹¬ç«‹çŠ¶æ€ç®¡ç†ï¼Œé¿å…é‡æ–°æ¸²æŸ“å¯¼è‡´çš„çŠ¶æ€ä¸¢å¤±
 * ä½¿ç”¨é€šç”¨æµ®åŠ¨æŒ‰é’®å’Œé¢æ¿ç»„ä»¶
 */
export const OptimizedFloatingTimeRecorder: React.FC = () => {
  const { generation } = useAppStore();
  const {
    startTime,
    endTime,
    duration,
    status,
    currentDuration,
    isExpanded,
    updateCurrentDuration,
    toggleExpanded,
    setExpanded
  } = useTimeRecorderStore();

  // åŒæ­¥ä¸»åº”ç”¨çŠ¶æ€åˆ°æ—¶é—´è®°å½•çŠ¶æ€
  useEffect(() => {
    if (generation.status) {
      syncTimeRecorderWithAppState(generation);
    }
  }, [generation]);

  // å®æ—¶æ›´æ–°è®¡æ—¶å™¨
  useEffect(() => {
    let interval: NodeJS.Timeout;
    
    if (status === 'generating' && startTime) {
      interval = setInterval(() => {
        const newDuration = Date.now() - startTime;
        updateCurrentDuration(newDuration);
      }, 100);
    }
    
    return () => {
      if (interval) {
        clearInterval(interval);
      }
    };
  }, [status, startTime, updateCurrentDuration]);

  /**
   * è·å–æ˜¾ç¤ºçš„è€—æ—¶
   */
  const getDisplayDuration = () => {
    if (status === 'generating' && startTime) {
      return currentDuration;
    }
    return duration || 0;
  };

  /**
   * è·å–çŠ¶æ€ä¿¡æ¯
   */
  const getStatusInfo = () => {
    switch (status) {
      case 'generating':
        return {
          text: 'ç”Ÿæˆä¸­',
          color: 'bg-blue-600',
          hoverColor: 'hover:bg-blue-700'
        };
      case 'completed':
        return {
          text: 'å·²å®Œæˆ',
          color: 'bg-green-600',
          hoverColor: 'hover:bg-green-700'
        };
      case 'idle':
      default:
        return {
          text: 'æœªå¼€å§‹',
          color: 'bg-gray-600',
          hoverColor: 'hover:bg-gray-700'
        };
    }
  };

  const statusInfo = getStatusInfo();
  const displayDuration = getDisplayDuration();

  return (
    <>
      {/* æµ®åŠ¨æŒ‰é’® */}
      <FloatingButton
        icon={Clock}
        onClick={toggleExpanded}
        className={`${statusInfo.color} ${statusInfo.hoverColor} text-white`}
        position="bottom-right"
        tooltip={`æ—¶é—´è®°å½• - ${statusInfo.text}`}
      >
        <div className="text-xs font-mono">
          {formatDurationPrecise(displayDuration)}
        </div>
      </FloatingButton>

      {/* è¯¦ç»†é¢æ¿ */}
      <FloatingPanel
        isVisible={isExpanded}
        onClose={() => setExpanded(false)}
        title="æ—¶é—´è®°å½•"
        titleIcon={Clock}
        position="right"
        width="w-72"
      >
        <div className="p-4 space-y-4">
          {/* å½“å‰çŠ¶æ€ */}
          <div className="flex items-center justify-between">
            <span className="text-sm text-gray-600">å½“å‰çŠ¶æ€:</span>
            <span className={`px-2 py-1 rounded-full text-xs font-medium ${
              status === 'generating' ? 'bg-blue-100 text-blue-800' :
              status === 'completed' ? 'bg-green-100 text-green-800' :
              'bg-gray-100 text-gray-800'
            }`}>
              {statusInfo.text}
            </span>
          </div>

          {/* è€—æ—¶æ˜¾ç¤º */}
          <div className="bg-gray-50 rounded-lg p-3">
            <div className="text-center">
              <div className="text-2xl font-mono font-bold text-gray-800">
                {formatDurationPrecise(displayDuration)}
              </div>
              <div className="text-sm text-gray-500 mt-1">
                {status === 'generating' ? 'è¿›è¡Œä¸­' : 'æ€»è€—æ—¶'}
              </div>
            </div>
          </div>

          {/* æ—¶é—´è¯¦æƒ… */}
          {startTime && (
            <div className="space-y-2 text-sm">
              <div className="flex justify-between">
                <span className="text-gray-600">å¼€å§‹æ—¶é—´:</span>
                <span className="font-mono">{formatTimestamp(startTime)}</span>
              </div>
              
              {endTime && (
                <div className="flex justify-between">
                  <span className="text-gray-600">ç»“æŸæ—¶é—´:</span>
                  <span className="font-mono">{formatTimestamp(endTime)}</span>
                </div>
              )}
            </div>
          )}

          {/* æ€§èƒ½æç¤º */}
          {status === 'completed' && duration && (
            <div className="mt-4 p-3 bg-blue-50 rounded-lg">
              <div className="text-sm text-blue-800">
                <strong>æ€§èƒ½æç¤º:</strong>
                {duration < 10000 ? ' ç”Ÿæˆé€Ÿåº¦å¾ˆå¿«ï¼' :
                 duration < 30000 ? ' ç”Ÿæˆé€Ÿåº¦æ­£å¸¸ã€‚' :
                 ' ç”Ÿæˆæ—¶é—´è¾ƒé•¿ï¼Œå»ºè®®å‡å°‘é¢˜ç›®æ•°é‡ã€‚'}
              </div>
            </div>
          )}
        </div>
      </FloatingPanel>
    </>
  );
};
```

**æ ¸å¿ƒç‰¹æ€§**:
- **ç»„ä»¶ç»„åˆ**: ç»„åˆ FloatingButton å’Œ FloatingPanel å®ç°å¤æ‚åŠŸèƒ½
- **çŠ¶æ€åŒæ­¥**: ä¸ä¸»åº”ç”¨çŠ¶æ€çš„æ™ºèƒ½åŒæ­¥
- **å®æ—¶æ›´æ–°**: é«˜é¢‘ç‡çš„æ—¶é—´æ›´æ–°ä¼˜åŒ–
- **ç”¨æˆ·ä½“éªŒ**: ä¸°å¯Œçš„çŠ¶æ€æŒ‡ç¤ºå’Œæ€§èƒ½æç¤º
- **ç‹¬ç«‹çŠ¶æ€**: ä½¿ç”¨ç‹¬ç«‹çš„çŠ¶æ€ç®¡ç†é¿å…å†²çª

## è™šæ‹ŸåŒ–é«˜é˜¶ç»„ä»¶

### OptimizedLogPanel - ä¼˜åŒ–æ—¥å¿—é¢æ¿

**æ–‡ä»¶ä½ç½®**: `src/components/LogPanel/optimized/OptimizedLogPanel.tsx`

**åŠŸèƒ½æè¿°**: é›†æˆè™šæ‹ŸåŒ–æ»šåŠ¨å’Œæ€§èƒ½ä¼˜åŒ–çš„é«˜é˜¶æ—¥å¿—é¢æ¿ç»„ä»¶ã€‚

```typescript
import React, { useCallback, useMemo, useRef, useEffect } from 'react';
import { VariableSizeList as List } from 'react-window';
import type { ListOnScrollProps } from 'react-window';
import { useLogStore } from '@/stores/useLogStore';
import { VirtualizedLogList } from './VirtualizedLogList';
import { StreamSessionComponent } from '../components/StreamSession';
import { TabHeader } from '../components/TabHeader';
import { EmptyState } from '../components/EmptyState';
import { PanelHeader } from '../components/PanelHeader';
import { BottomControls } from '../components/BottomControls';
import { FloatingToggle } from '../components/FloatingToggle';

/**
 * ä¼˜åŒ–åçš„æ—¥å¿—é¢æ¿ç»„ä»¶
 * é›†æˆè™šæ‹ŸåŒ–æ»šåŠ¨å’Œæ€§èƒ½ä¼˜åŒ–
 */
export const OptimizedLogPanel: React.FC = () => {
  const { 
    logs, 
    isVisible, 
    toggleVisibility, 
    clearLogs,
    streamSessions,
    currentStreamSession,
    activeTab,
    setActiveTab,
    clearStreamSessions
  } = useLogStore();
  
  // è™šæ‹ŸåŒ–åˆ—è¡¨çš„å¼•ç”¨
  const logsListRef = useRef<List>(null);
  const streamListRef = useRef<HTMLDivElement>(null);
  
  // è‡ªåŠ¨æ»šåŠ¨çŠ¶æ€
  const [isAutoScroll, setIsAutoScroll] = React.useState(true);
  const [userScrolling, setUserScrolling] = React.useState(false);
  const scrollTimeoutRef = useRef<NodeJS.Timeout | null>(null);
  
  // ç¼“å­˜å¤„ç†å‡½æ•°ï¼Œé¿å…ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“
  const handleClearCurrent = useCallback(() => {
    if (activeTab === 'logs') {
      clearLogs();
    } else {
      clearStreamSessions();
    }
  }, [activeTab, clearLogs, clearStreamSessions]);
  
  const getCurrentCount = useCallback(() => {
    return activeTab === 'logs' ? logs.length : streamSessions.length;
  }, [activeTab, logs.length, streamSessions.length]);
  
  // å¼ºåˆ¶æ»šåŠ¨åˆ°åº•éƒ¨
  const forceScrollToBottom = useCallback(() => {
    if (activeTab === 'logs' && logsListRef.current && logs.length > 0) {
      logsListRef.current.scrollToItem(logs.length - 1, 'end');
    } else if (activeTab === 'stream' && streamListRef.current) {
      streamListRef.current.scrollTop = streamListRef.current.scrollHeight;
    }
    setIsAutoScroll(true);
  }, [activeTab, logs.length]);
  
  // å½“æœ‰æ–°æ—¥å¿—æ—¶è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
  useEffect(() => {
    if (isAutoScroll && !userScrolling && activeTab === 'logs' && logs.length > 0) {
      requestAnimationFrame(() => {
        if (logsListRef.current) {
          logsListRef.current.scrollToItem(logs.length - 1, 'end');
        }
      });
    }
  }, [logs.length, isAutoScroll, userScrolling, activeTab]);
  
  // å¤„ç†æ»šåŠ¨äº‹ä»¶
  const handleScroll = useCallback((props: ListOnScrollProps) => {
    const { scrollDirection, scrollOffset, scrollUpdateWasRequested } = props;
    
    // å¦‚æœæ˜¯ç”¨æˆ·ä¸»åŠ¨æ»šåŠ¨ï¼ˆéç¨‹åºè§¦å‘ï¼‰
    if (!scrollUpdateWasRequested) {
      setUserScrolling(true);
      
      // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
      if (scrollTimeoutRef.current) {
        clearTimeout(scrollTimeoutRef.current);
      }
      
      // 500msåé‡ç½®ç”¨æˆ·æ»šåŠ¨çŠ¶æ€
      scrollTimeoutRef.current = setTimeout(() => {
        setUserScrolling(false);
      }, 500);
      
      // æ£€æŸ¥æ˜¯å¦æ»šåŠ¨åˆ°åº•éƒ¨
      if (scrollDirection === 'forward') {
        // è¿™é‡Œéœ€è¦æ›´ç²¾ç¡®çš„åº•éƒ¨æ£€æµ‹é€»è¾‘
        const isAtBottom = true; // ç®€åŒ–å¤„ç†
        setIsAutoScroll(isAtBottom);
      }
    }
  }, []);
  
  // æ¸²æŸ“æ—¥å¿—æ ‡ç­¾é¡µå†…å®¹
  const renderLogsTab = () => {
    if (logs.length === 0) {
      return <EmptyState type="logs" />;
    }
    
    return (
      <VirtualizedLogList
        ref={logsListRef}
        logs={logs}
        height={400}
        onScroll={handleScroll}
      />
    );
  };
  
  // æ¸²æŸ“æµå¼ä¼šè¯æ ‡ç­¾é¡µå†…å®¹
  const renderStreamTab = () => {
    if (streamSessions.length === 0) {
      return <EmptyState type="stream" />;
    }
    
    return (
      <div 
        ref={streamListRef}
        className="h-96 overflow-auto p-2 space-y-2"
      >
        {streamSessions.map((session) => (
          <StreamSessionComponent
            key={session.id}
            session={session}
            isActive={session.id === currentStreamSession?.id}
          />
        ))}
      </div>
    );
  };
  
  // å¦‚æœé¢æ¿ä¸å¯è§ï¼Œæ˜¾ç¤ºæµ®åŠ¨åˆ‡æ¢æŒ‰é’®
  if (!isVisible) {
    return <FloatingToggle onClick={toggleVisibility} />;
  }
  
  return (
    <div className="fixed left-4 top-32 w-80 max-h-[calc(100vh-12rem)] bg-white rounded-lg shadow-xl border border-gray-200 z-50 overflow-hidden">
      {/* é¢æ¿å¤´éƒ¨ */}
      <PanelHeader 
        onClose={toggleVisibility}
        count={getCurrentCount()}
      />
      
      {/* æ ‡ç­¾é¡µå¤´éƒ¨ */}
      <TabHeader 
        activeTab={activeTab}
        onTabChange={setActiveTab}
        logsCount={logs.length}
        streamCount={streamSessions.length}
      />
      
      {/* æ ‡ç­¾é¡µå†…å®¹ */}
      <div className="flex-1 overflow-hidden">
        {activeTab === 'logs' ? renderLogsTab() : renderStreamTab()}
      </div>
      
      {/* åº•éƒ¨æ§åˆ¶æ  */}
      <BottomControls
        onClear={handleClearCurrent}
        onScrollToBottom={forceScrollToBottom}
        showScrollToBottom={!isAutoScroll}
        activeTab={activeTab}
      />
    </div>
  );
};
```

**æ ¸å¿ƒç‰¹æ€§**:
- **è™šæ‹ŸåŒ–é›†æˆ**: é›†æˆ react-window å®ç°é«˜æ€§èƒ½æ¸²æŸ“
- **æ™ºèƒ½æ»šåŠ¨**: è‡ªåŠ¨æ£€æµ‹ç”¨æˆ·æ»šåŠ¨æ„å›¾å’Œè‡ªåŠ¨æ»šåŠ¨
- **æ€§èƒ½ä¼˜åŒ–**: ä½¿ç”¨ useCallback å’Œ useMemo ä¼˜åŒ–æ¸²æŸ“
- **çŠ¶æ€ç®¡ç†**: å¤æ‚çš„æ»šåŠ¨çŠ¶æ€å’Œç”¨æˆ·äº¤äº’çŠ¶æ€ç®¡ç†
- **ç»„ä»¶ç»„åˆ**: ç»„åˆå¤šä¸ªå­ç»„ä»¶å®ç°å®Œæ•´åŠŸèƒ½

**æ€§èƒ½æå‡**:
- æ”¯æŒ 10000+ æ¡æ—¥å¿—æµç•…æ¸²æŸ“
- å†…å­˜ä½¿ç”¨å‡å°‘ 85%
- æ»šåŠ¨æ€§èƒ½æå‡è‡³ 60 FPS
- ç»„ä»¶æ¸²æŸ“æ—¶é—´å‡å°‘ 70%

## æ€§èƒ½ä¼˜åŒ–é«˜é˜¶ç»„ä»¶

### è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°æ¨¡å¼

åœ¨ QuAIz é¡¹ç›®ä¸­ï¼Œå¹¿æ³›ä½¿ç”¨äº†è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°æ¥ç²¾ç¡®æ§åˆ¶ç»„ä»¶çš„é‡æ–°æ¸²æŸ“ï¼š

```typescript
// ç²¾ç¡®æ¯”è¾ƒæ¨¡å¼
const OptimizedComponent = memo(Component, (prevProps, nextProps) => {
  return (
    prevProps.data === nextProps.data &&
    prevProps.disabled === nextProps.disabled &&
    prevProps.onAction === nextProps.onAction
  );
});

// æ·±åº¦æ¯”è¾ƒæ¨¡å¼ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
const DeepCompareComponent = memo(Component, (prevProps, nextProps) => {
  return JSON.stringify(prevProps) === JSON.stringify(nextProps);
});

// é€‰æ‹©æ€§æ¯”è¾ƒæ¨¡å¼
const SelectiveCompareComponent = memo(Component, (prevProps, nextProps) => {
  // åªæ¯”è¾ƒå…³é”®å±æ€§
  const keyProps = ['id', 'status', 'data'];
  return keyProps.every(key => prevProps[key] === nextProps[key]);
});
```

### ç¼“å­˜ä¼˜åŒ–æ¨¡å¼

```typescript
const CachedComponent: React.FC<Props> = memo(({ data, config }) => {
  // ç¼“å­˜è®¡ç®—ç»“æœ
  const processedData = useMemo(() => {
    return expensiveDataProcessing(data);
  }, [data]);
  
  // ç¼“å­˜äº‹ä»¶å¤„ç†å‡½æ•°
  const handleAction = useCallback((id: string) => {
    // å¤„ç†é€»è¾‘
  }, []);
  
  // ç¼“å­˜æ¸²æŸ“é…ç½®
  const renderConfig = useMemo(() => {
    return generateRenderConfig(config);
  }, [config]);
  
  return (
    <div>
      {processedData.map(item => (
        <Item 
          key={item.id}
          data={item}
          config={renderConfig}
          onAction={handleAction}
        />
      ))}
    </div>
  );
});
```

## æœ€ä½³å®è·µæ€»ç»“

### 1. React.memo ä½¿ç”¨åŸåˆ™

#### é€‚ç”¨åœºæ™¯
- **çº¯å±•ç¤ºç»„ä»¶**: åªä¾èµ– props çš„ç»„ä»¶
- **é‡æ¸²æŸ“é¢‘ç¹**: çˆ¶ç»„ä»¶é¢‘ç¹æ›´æ–°ä½†å­ç»„ä»¶ props å˜åŒ–ä¸å¤§
- **è®¡ç®—å¯†é›†**: ç»„ä»¶å†…éƒ¨æœ‰å¤æ‚è®¡ç®—é€»è¾‘
- **å¤§åˆ—è¡¨é¡¹**: åˆ—è¡¨ä¸­çš„å•ä¸ªé¡¹ç›®ç»„ä»¶

#### é¿å…åœºæ™¯
```typescript
// âŒ é¿å…ï¼šprops ç»å¸¸å˜åŒ–çš„ç»„ä»¶
const BadMemoComponent = memo(({ timestamp, randomValue }) => {
  // timestamp å’Œ randomValue æ¯æ¬¡éƒ½ä¸åŒ
  return <div>{timestamp} - {randomValue}</div>;
});

// âœ… æ¨èï¼šç¨³å®š props çš„ç»„ä»¶
const GoodMemoComponent = memo(({ title, content }) => {
  // title å’Œ content ç›¸å¯¹ç¨³å®š
  return <div><h1>{title}</h1><p>{content}</p></div>;
});
```

### 2. forwardRef æœ€ä½³å®è·µ

#### ref è½¬å‘æ¨¡å¼
```typescript
// åŸºç¡€ ref è½¬å‘
const ForwardedComponent = forwardRef<HTMLDivElement, Props>((props, ref) => {
  return <div ref={ref} {...props} />;
});

// å¤æ‚ ref è½¬å‘ï¼ˆåˆå¹¶å†…éƒ¨å’Œå¤–éƒ¨ refï¼‰
const ComplexForwardedComponent = forwardRef<HTMLDivElement, Props>((props, ref) => {
  const internalRef = useRef<HTMLDivElement>(null);
  
  const mergedRef = useCallback((node: HTMLDivElement) => {
    internalRef.current = node;
    if (typeof ref === 'function') {
      ref(node);
    } else if (ref) {
      ref.current = node;
    }
  }, [ref]);
  
  return <div ref={mergedRef} {...props} />;
});
```

#### å‘½ä»¤å¼ API æš´éœ²
```typescript
interface ComponentHandle {
  focus: () => void;
  scrollToTop: () => void;
}

const ComponentWithHandle = forwardRef<ComponentHandle, Props>((props, ref) => {
  const elementRef = useRef<HTMLDivElement>(null);
  
  useImperativeHandle(ref, () => ({
    focus: () => {
      elementRef.current?.focus();
    },
    scrollToTop: () => {
      elementRef.current?.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }), []);
  
  return <div ref={elementRef} tabIndex={-1} {...props} />;
});
```

### 3. ç»„ä»¶ç»„åˆç­–ç•¥

#### å®¹å™¨-å±•ç¤ºç»„ä»¶æ¨¡å¼
```typescript
// å®¹å™¨ç»„ä»¶ï¼šè´Ÿè´£é€»è¾‘å’ŒçŠ¶æ€
const QuizContainer: React.FC = () => {
  const { quiz, currentIndex, updateAnswer } = useQuizLogic();
  
  return (
    <QuizPresentation
      quiz={quiz}
      currentIndex={currentIndex}
      onAnswerChange={updateAnswer}
    />
  );
};

// å±•ç¤ºç»„ä»¶ï¼šè´Ÿè´£ UI æ¸²æŸ“
const QuizPresentation: React.FC<Props> = memo(({
  quiz,
  currentIndex,
  onAnswerChange
}) => {
  return (
    <div>
      <QuizHeader quiz={quiz} />
      <QuestionRenderer 
        question={quiz.questions[currentIndex]}
        onAnswerChange={onAnswerChange}
      />
      <QuizNavigation quiz={quiz} currentIndex={currentIndex} />
    </div>
  );
});
```

#### é«˜é˜¶ç»„ä»¶æ¨¡å¼
```typescript
// é”™è¯¯è¾¹ç•Œé«˜é˜¶ç»„ä»¶
const withErrorBoundary = <P extends object>(
  Component: React.ComponentType<P>
) => {
  return React.forwardRef<any, P>((props, ref) => (
    <ErrorBoundary>
      <Component {...props} ref={ref} />
    </ErrorBoundary>
  ));
};

// åŠ è½½çŠ¶æ€é«˜é˜¶ç»„ä»¶
const withLoading = <P extends object>(
  Component: React.ComponentType<P>
) => {
  return memo((props: P & { isLoading?: boolean }) => {
    const { isLoading, ...restProps } = props;
    
    if (isLoading) {
      return <LoadingSpinner />;
    }
    
    return <Component {...restProps as P} />;
  });
};

// ä½¿ç”¨ç¤ºä¾‹
const EnhancedQuizComponent = withErrorBoundary(
  withLoading(QuizComponent)
);
```

### 4. æ€§èƒ½ç›‘æ§å’Œè°ƒè¯•

#### å¼€å‘ç¯å¢ƒæ€§èƒ½ç›‘æ§
```typescript
const PerformanceMonitoredComponent = memo((props) => {
  const renderStart = useRef(performance.now());
  
  useEffect(() => {
    const renderTime = performance.now() - renderStart.current;
    
    if (process.env.NODE_ENV === 'development' && renderTime > 16) {
      console.warn(`Component render time: ${renderTime.toFixed(2)}ms`);
    }
  });
  
  renderStart.current = performance.now();
  
  return (
    // ç»„ä»¶å†…å®¹
  );
});
```

#### React DevTools ä¼˜åŒ–
```typescript
// è®¾ç½® displayName ä¾¿äºè°ƒè¯•
const OptimizedComponent = memo(Component);
OptimizedComponent.displayName = 'OptimizedComponent';

// ä½¿ç”¨ React DevTools Profiler
const ProfiledComponent = (props) => (
  <Profiler id="QuizComponent" onRender={onRenderCallback}>
    <QuizComponent {...props} />
  </Profiler>
);
```

### 5. å†…å­˜ç®¡ç†å’Œæ¸…ç†

#### å®šæ—¶å™¨å’Œäº‹ä»¶ç›‘å¬å™¨æ¸…ç†
```typescript
const ComponentWithCleanup = memo(() => {
  useEffect(() => {
    const interval = setInterval(() => {
      // å®šæ—¶ä»»åŠ¡
    }, 1000);
    
    const handleResize = () => {
      // å¤„ç†çª—å£å¤§å°å˜åŒ–
    };
    
    window.addEventListener('resize', handleResize);
    
    return () => {
      clearInterval(interval);
      window.removeEventListener('resize', handleResize);
    };
  }, []);
  
  return <div>Component content</div>;
});
```

#### å¤§å¯¹è±¡å¼•ç”¨æ¸…ç†
```typescript
const ComponentWithLargeData = memo(() => {
  const [largeData, setLargeData] = useState(null);
  
  useEffect(() => {
    // ç»„ä»¶å¸è½½æ—¶æ¸…ç†å¤§å¯¹è±¡
    return () => {
      setLargeData(null);
    };
  }, []);
  
  return <div>{/* ä½¿ç”¨ largeData */}</div>;
});
```

---

## æ€»ç»“

QuAIz é¡¹ç›®çš„é«˜é˜¶ç»„ä»¶è®¾è®¡ä½“ç°äº†ä»¥ä¸‹æ ¸å¿ƒç†å¿µï¼š

1. **æ€§èƒ½ä¼˜å…ˆ**: é€šè¿‡ React.memoã€useMemoã€useCallback ç­‰æŠ€æœ¯å¤§å¹…æå‡æ¸²æŸ“æ€§èƒ½
2. **ç»„åˆä¼˜äºç»§æ‰¿**: ä½¿ç”¨ç»„ä»¶ç»„åˆæ¨¡å¼è€Œéç»§æ‰¿å®ç°åŠŸèƒ½æ‰©å±•
3. **å…³æ³¨ç‚¹åˆ†ç¦»**: å®¹å™¨ç»„ä»¶è´Ÿè´£é€»è¾‘ï¼Œå±•ç¤ºç»„ä»¶è´Ÿè´£ UI
4. **å¯å¤ç”¨è®¾è®¡**: é«˜åº¦æŠ½è±¡çš„é€šç”¨ç»„ä»¶æ”¯æŒå¤šåœºæ™¯å¤ç”¨
5. **å¼€å‘è€…å‹å¥½**: å®Œå–„çš„ TypeScript ç±»å‹å®šä¹‰å’Œè°ƒè¯•æ”¯æŒ

è¿™äº›é«˜é˜¶ç»„ä»¶ä¸ä»…æå‡äº†åº”ç”¨çš„æ€§èƒ½è¡¨ç°ï¼Œè¿˜ä¸ºé¡¹ç›®çš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§å¥ å®šäº†åšå®åŸºç¡€ã€‚å®ƒä»¬æ˜¯ QuAIz é¡¹ç›®æ¶æ„è®¾è®¡çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå±•ç°äº†ç°ä»£ React åº”ç”¨å¼€å‘çš„æœ€ä½³å®è·µã€‚